---
layout:     post
title:      ÁîüÊàêÂõæÂÉèËÆ≠ÁªÉÊï∞ÊçÆ
subtitle:    "\"ÁîüÊàêÂõæÂÉèËÆ≠ÁªÉÊï∞ÊçÆ\""
date:       2018-08-28
author:     PZ
header-img: img/post-bg-2015.jpg
catalog: true
tags:
    - PIL
    - ËÑöÊú¨
---

```
2018-08-28-AI-ÁîüÊàêÂõæÂÉèËÆ≠ÁªÉÊï∞ÊçÆ‰πà.md
```

> ‚Äúüôâüôâüôâ ‚Äù


## ÁîüÊàêÂõæÂÉèËÆ≠ÁªÉÊï∞ÊçÆ

```
import os
import random
from PIL import Image,ImageDraw,ImageFont
import traceback
import re
from collections import Counter
import sys
from faker import Faker
import numpy as np

# Á∫øÊÆµÂô™Â£∞Êï∞
ratio_noise_line = 0.05

# Á∫øÊ®™ÂêëÊØî‰æã
ratio_line_horizontal=0.1

# ÂõæÂÉèËæπÊ°Ü‰ΩôÈáè 36ÂÉèÁ¥†
margin_hor = 36
margin_ver = 36
sep_div = 50

'''
rootDir : Ê†πÁõÆÂΩï
filelist : ÁîüÊàêÊñá‰ª∂Ê∏ÖÂçï
pattern : Êñá‰ª∂ÂåπÈÖçËßÑÂàô
'''
def ReadPath(rootDir, filelist,pattern):
    for lists in os.listdir(rootDir):
        path = os.path.join(rootDir, lists)
        re_result = re.search(pattern, path, re.IGNORECASE)
        if re_result is not None:
            filelist.append(path)
        if os.path.isdir(path):
            ReadPath(path)

'''
‰ΩøÁî®fakerÂåÖÁîüÊàêlist_word - ÊîØÊåÅ‰∏ÄÁßçÊï∞ÊçÆÁ±ªÂûã
f = Faker(locale='zh_CN')
f.address()
[f_fun]: ÂõûË∞ÉÂáΩÊï∞lists
'''
def gen_list_words_by_faker(list_word , listnums,f_fun):
    for i in range(listnums):
        word = f_fun()
        list_word.append(word)
    return list_word


'''
‰ΩøÁî®fakerÂåÖÁîüÊàêlist_word - ÊîØÊåÅÁîüÊàêÂ§öÁßçÊï∞ÊçÆÁßçÁ±ª,Âπ∂‰∏îÊåâÁÖßÁâπÂÆöÊØî‰æã
f = Faker(locale='zh_CN')
f.address()
f_fun = [f.credit_card_number,f.address]
f_fun_proportion = [0.1,0.9]
'''
def gen_list_words_by_faker_bt(list_word , listnums,f_fun,f_fun_proportion):
    for i in range(listnums):
        f = np.random.choice(f_fun, 1, p = f_fun_proportion)
        f = f.tolist()[0]
        word = f()
        list_word.append(word)
    return list_word


'''
ÈÄöËøáÊñáÁ´†Êù•ÁîüÊàêÂÜÖÂÆπ
'''
def gen_list_words_by_paper(list_word):
    pass



class generate_pic(object):

    '''
    self.fontlists = []      Â≠ó‰ΩìÁ±ªÂûã
    self.fontpath = 'fonts'  Â≠ó‰ΩìÊñá‰ª∂Ë∑ØÂæÑ
    self.fontsizelists = []  Â≠ó‰ΩìÂ§ßÂ∞èlist
    self.wordlists = []      word lists
    self.wordnum = 1000      word lists number
    '''
    def __init__(self):
        try:
            self.fontlists = []
            self.fontpath = 'fonts'
            self.fontsizelists = []
            self.wordlists = []
            self.wordnum = 1000
            self.baseimagepath = 'images_base'  #ËÉåÊôØÂõæ
            self.baseimagelist = []

            if not os.path.exists(self.fontpath):
                raise Exception("fonts ford is not exists")
            ReadPath(self.fontpath,self.fontlists,'.[tT][tF][fF]$')
            # ÁîüÊàê Â≠ó‰ΩìÂàóË°®
            print(self.fontlists)


            # ÁîüÊàê Â≠ó‰ΩìÂ§ßÂ∞èÂàóË°®
            self.fontsizelists = [30,35,40,45,50]

            # ÁîüÊàê string ÂàóË°®
            f = Faker(locale='zh_CN')
            # self.wordlists = gen_list_words_by_faker(self.wordlists,self.wordnum,f.credit_card_number)
            self.wordlists = gen_list_words_by_faker_bt(self.wordlists, self.wordnum, [f.credit_card_number,f.address],[0.5,0.5])

            print(self.wordlists)

            # Âü∫Á°ÄÂõæÁâáÁ±ªÂûã
            if not os.path.exists(self.baseimagepath):
                raise Exception("baseimagepath is not exists")
            ReadPath(self.baseimagepath,self.baseimagelist,'.[p][n][g]$')
            print(self.baseimagelist)

            # Âü∫Á°ÄÂõæÁâáÊâìÂºÄ
            # self.baseimage = Image.open(self.baseimagelist[0])
            # self.baseimage.show()


        except Exception as e:
            traceback.print_exc()



    def drawLineNoise(self, draw, width, height):
        #
        for i in range(100):
            # Á∫øÁöÑÂô™Â£∞Êï∞
            if random.random() > ratio_noise_line:
                continue
            #
            x0 = random.randint(0, width)
            x1 = random.randint(0, width)
            y0 = random.randint(0, height)
            y1 = random.randint(0, height)
            # ratio_line_horizontal : Ê®™ÂêëÁ∫ø
            if random.random() < ratio_line_horizontal:
                y1 = y0
            # Á∫øÂÆΩ
            line_width = random.randint(1,4)
            # fill:000 ÈªëËâ≤(RGB)
            draw.line([(x0,y0),(x1,y1)], fill = (0,0,0), width = line_width)

    def gentext(self,draw,start_point,imgsize,**kwargs):

        if not 'text' in kwargs:
            a_text = random.choice(self.wordlists)
        else:
            a_text = kwargs['text']

        if not 'font' in kwargs:
            a_font = random.choice(self.fontlists)
        else:
            a_font = kwargs['font']

        if not 'fontsize' in kwargs:
            a_fontsize = random.choice(self.fontsizelists)
        else:
            a_fontsize = kwargs['fontsize']

        if not 'underline' in kwargs:
            a_underline = True
        else:
            a_underline = kwargs['underline']

        if not 'rect' in kwargs:
            a_rect = True
        else:
            a_rect = kwargs['rect']

        font = ImageFont.truetype(a_font, a_fontsize)

        # im = self.baseimage
        # dr = ImageDraw.Draw(im)
        # ÂºÄÂßã‰ΩçÁΩÆ
        (x0,y0) = start_point
        # Â∞ÜÂ≠ó‰ΩìÁîªÂÖ•ÂõæÁâá
        test_w, test_h = draw.textsize(a_text, font)

        if (x0+test_w) > imgsize[0] or (y0+test_h) > imgsize[1]:
            print('out of pic:\n')
            print(x0,y0,test_w,test_h,imgsize[0],imgsize[1])
            return None

        draw.text((x0,y0),a_text, font=font, fill="#000000")

        if a_underline:
            test_h_ = test_h + random.randint(1, 5)
            test_w_ = test_w + random.randint(1, 5)
            draw.line( [(x0,y0+test_h_),(x0+test_w_,y0+test_h_)],fill=(0, 0, 0), width=random.randint(2, 5))

        if a_rect:
            x0_ = x0 - random.randint(4, 8)
            y0_ = y0 - random.randint(4, 8)
            test_h_ = test_h + random.randint(8, 12)
            test_w_ = test_w + random.randint(8, 12)
            draw.line([(x0_,y0_),(x0_,y0_+test_h_),(x0_+test_w_,y0_+test_h_),(x0_+test_w_,y0_),(x0_,y0_)],fill=(0, 0, 0), width=random.randint(2, 5))

        return (a_text,x0,y0,test_w,test_h)



def test():

    a = generate_pic()
    img = Image.open(a.baseimagelist[0])
    draw = ImageDraw.Draw(img)
    a.drawLineNoise(draw,img.size[0],img.size[1])
    # img.show(img)

    result = a.gentext(draw,(15,10),img.size,rect=False)
    if result is not None:
        (a_text, x0, y0, test_w, test_h) = result
        print(a_text, x0, y0, test_w, test_h)

    before_y = y0 + test_h +10
    result = a.gentext(draw,(15,before_y),img.size,rect=False)
    if result is not None:
        (a_text, x0, y0, test_w, test_h) = result
        print(a_text, x0, y0, test_w, test_h)

    img.show(img)


def test_for():

    a = generate_pic()
    img = Image.open(a.baseimagelist[0])
    draw = ImageDraw.Draw(img)
    a.drawLineNoise(draw,img.size[0],img.size[1])
    # img.show(img)

    x_ = random.randint(15, 100)
    y_ = random.randint(15, 30)
    test_h = 0
    for i in range(5):
        x = random.randint(15,100)
        y = y_ + test_h + random.randint(15,100)
        result = a.gentext(draw,(x,y),img.size,rect=False)
        if result is not None:
            (a_text, x0, y0, test_w, test_h) = result
            print(a_text, x0, y0, test_w, test_h)
        y_ = y

    img.show(img)

if __name__ == '__main__':
    #test()
    test_for()





    # img_draw = Image.open('images_base/bg_0.png')
    # img_size = img_draw.size  # (width, height)
    # draw = ImageDraw.Draw(img_draw)
    # a.drawLineNoise(draw,img_size[0],img_size[1])
    #
    # font_file = 'fonts/tecnico_bold.ttf'
    # text_size = 44
    # text_str = 'HUSAFDSFADF'
    # # Â≠ó‰Ωì
    # font = ImageFont.truetype(font_file, text_size)
    # draw.text((50, 50), text_str, (0, 0, 0), font=font)
    #
    # img_draw.show()

```
